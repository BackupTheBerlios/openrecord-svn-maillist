<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [openrecord-svn] r367 - in trunk: source/archive source/storage tests tests/model tests/storage tests/storage/directory_1 tests/storage/directory_1/subdirectory_1
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/openrecord-svn/2005-October/index.html" >
   <LINK REL="made" HREF="mailto:openrecord-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenrecord-svn%5D%20r367%20-%20in%20trunk%3A%20source/archive%20source/storage%20tests%20tests/model%20tests/storage%20tests/storage/directory_1%20tests/storage/directory_1/subdirectory_1&In-Reply-To=%3C200510250317.j9P3HKHU000881%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000348.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[openrecord-svn] r367 - in trunk: source/archive source/storage tests tests/model tests/storage tests/storage/directory_1 tests/storage/directory_1/subdirectory_1</H1>
    <B>Mignon Belongie at BerliOS</B> 
    <A HREF="mailto:openrecord-svn%40lists.berlios.de?Subject=Re%3A%20%5Bopenrecord-svn%5D%20r367%20-%20in%20trunk%3A%20source/archive%20source/storage%20tests%20tests/model%20tests/storage%20tests/storage/directory_1%20tests/storage/directory_1/subdirectory_1&In-Reply-To=%3C200510250317.j9P3HKHU000881%40sheep.berlios.de%3E"
       TITLE="[openrecord-svn] r367 - in trunk: source/archive source/storage tests tests/model tests/storage tests/storage/directory_1 tests/storage/directory_1/subdirectory_1">mignon at berlios.de
       </A><BR>
    <I>Tue Oct 25 05:17:20 CEST 2005</I>
    <P><UL>
        <LI>Previous message: <A HREF="000348.html">[openrecord-svn] r366 - trunk/documentation
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#349">[ date ]</a>
              <a href="thread.html#349">[ thread ]</a>
              <a href="subject.html#349">[ subject ]</a>
              <a href="author.html#349">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mignon
Date: 2005-10-25 05:17:18 +0200 (Tue, 25 Oct 2005)
New Revision: 367

Added:
   trunk/source/storage/FileSystem.js
   trunk/source/storage/get_list_of_files_in_dir.php
   trunk/tests/storage/DirectoryReadingTest.html
   trunk/tests/storage/DirectoryReadingTest.js
   trunk/tests/storage/StorageTest.html
   trunk/tests/storage/StorageTest.js
   trunk/tests/storage/TestSuite.html
   trunk/tests/storage/directory_1/
   trunk/tests/storage/directory_1/subdirectory_1/
   trunk/tests/storage/directory_1/subdirectory_1/javascript_file_1.js
   trunk/tests/storage/directory_1/subdirectory_1/javascript_file_2.js
   trunk/tests/storage/directory_1/subdirectory_1/suffixless_file_1
   trunk/tests/storage/directory_1/subdirectory_1/text_file_1.txt
   trunk/tests/storage/directory_1/subdirectory_1/text_file_2.txt
   trunk/tests/storage/directory_1/subdirectory_1/text_file_3.txt
Modified:
   trunk/source/archive/DeltaArchive.js
   trunk/source/storage/FakeStorage.js
   trunk/source/storage/FileStorage.js
   trunk/source/storage/HttpStorage.js
   trunk/source/storage/Storage.js
   trunk/tests/LintTest.js
   trunk/tests/TestSuite.html
   trunk/tests/model/RepositoryWritingTest.js
   trunk/tests/storage/LintTest.js
Log:
Added FileSystem.js and get_list_of_files_in_dir.php for getting directory listings, and DirectoryReadingTest to test them.  Moved the storage-only parts of RepositoryWritingTest to new test StorageTest.  Removed FileStorage's dependency on DeltaArchive.  Added orp.storage.PATH_TO_PHP_FILES_FROM_TRUNK.


Modified: trunk/source/archive/DeltaArchive.js
===================================================================
--- trunk/source/archive/DeltaArchive.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/archive/DeltaArchive.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -153,10 +153,14 @@
   }
   if (window.location) {
     if (window.location.protocol == &quot;http:&quot;) {
-      this._saverObject = new orp.storage.HttpStorage(this._repositoryName, this._pathToTrunkDirectory);
+      this._saverObject = new orp.storage.HttpStorage(this._repositoryName,
+                                                      orp.archive.DeltaArchive.PATH_TO_REPOSITORY_DIRECTORY,
+                                                      this._pathToTrunkDirectory);
     }
     if (window.location.protocol == &quot;file:&quot;) {
-      this._saverObject = new orp.storage.FileStorage(this._repositoryName, this._pathToTrunkDirectory);
+      this._saverObject = new orp.storage.FileStorage(this._repositoryName,
+                                                      orp.archive.DeltaArchive.PATH_TO_REPOSITORY_DIRECTORY,
+                                                      this._pathToTrunkDirectory);
     }
   }
   if (!this._saverObject) {
@@ -190,10 +194,14 @@
   if (!this._saverObject) {
     if (window.location) {
       if (window.location.protocol == &quot;http:&quot;) {
-        this._saverObject = new orp.storage.HttpStorage(this._repositoryName, this._pathToTrunkDirectory);
+        this._saverObject = new orp.storage.HttpStorage(this._repositoryName,
+                                                        orp.archive.DeltaArchive.PATH_TO_REPOSITORY_DIRECTORY,
+                                                        this._pathToTrunkDirectory);
       }
       if (window.location.protocol == &quot;file:&quot;) {
-        this._saverObject = new orp.storage.FileStorage(this._repositoryName, this._pathToTrunkDirectory);
+        this._saverObject = new orp.storage.FileStorage(this._repositoryName,
+                                                        orp.archive.DeltaArchive.PATH_TO_REPOSITORY_DIRECTORY,
+                                                        this._pathToTrunkDirectory);
       }
     }
   }

Modified: trunk/source/storage/FakeStorage.js
===================================================================
--- trunk/source/storage/FakeStorage.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/storage/FakeStorage.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -47,8 +47,8 @@
  * @param    pathToTrunkDirectoryFromWindowLocation // Not needed if window location is at the root of the trunk directory.
  * @scope    public instance constructor
  */
-orp.storage.FakeStorage = function(repositoryName, pathToTrunkDirectoryFromWindowLocation) {
-  orp.storage.Storage.call(this, repositoryName, pathToTrunkDirectoryFromWindowLocation);
+orp.storage.FakeStorage = function(repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromWindowLocation) {
+  orp.storage.Storage.call(this, repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromWindowLocation);
   
   this._fakeFileContents = &quot;&quot;;
 };

Modified: trunk/source/storage/FileStorage.js
===================================================================
--- trunk/source/storage/FileStorage.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/storage/FileStorage.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -56,7 +56,6 @@
 // -------------------------------------------------------------------
 dojo.provide(&quot;orp.storage.FileStorage&quot;);
 dojo.require(&quot;orp.storage.Storage&quot;);
-dojo.require(&quot;orp.archive.DeltaArchive&quot;);
 dojo.require(&quot;orp.lang.Lang&quot;);
 
 
@@ -70,8 +69,8 @@
  * @param    pathToTrunkDirectory           // Not needed if window.location.pathname is in the trunk directory.
  * @scope    public instance constructor
  */
-orp.storage.FileStorage = function(repositoryName, pathToTrunkDirectory) {
-  orp.storage.Storage.call(this, repositoryName, pathToTrunkDirectory);
+orp.storage.FileStorage = function(repositoryName, repositoryDirectoryName, pathToTrunkDirectory) {
+  orp.storage.Storage.call(this, repositoryName, repositoryDirectoryName, pathToTrunkDirectory);
   
   // Step 1: Build the fileUrl
   // 
@@ -91,7 +90,7 @@
   if (pathToTrunkDirectory &amp;&amp; pathToTrunkDirectory !== &quot;&quot;) {
     listOfAdditions.push(pathToTrunkDirectory);
   }
-  listOfAdditions.push(orp.archive.DeltaArchive.PATH_TO_REPOSITORY_DIRECTORY);
+  listOfAdditions.push(this._repositoryDirectoryName);
   listOfAdditions.push(this.getRepositoryName() + &quot;.json&quot;);
   this._fileUrl = this._getLocalPathFromWindowLocation(listOfAdditions);
 };

Added: trunk/source/storage/FileSystem.js
===================================================================
--- trunk/source/storage/FileSystem.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/storage/FileSystem.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,131 @@
+/*****************************************************************************
+ FileSystem.js
+ 
+******************************************************************************
+ Written in 2005 by Mignon Belongie
+  
+ Copyright rights relinquished under the Creative Commons  
+ Public Domain Dedication:
+    <A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>
+  
+ You can copy freely from this file.  This work may be freely reproduced, 
+ distributed, transmitted, used, modified, built upon, or otherwise exploited
+ by anyone for any purpose.
+  
+ This work is provided on an &quot;AS IS&quot; basis, without warranties or conditions 
+ of any kind, either express or implied, including, without limitation, any 
+ warranties or conditions of title, non-infringement, merchantability, or 
+ fitness for a particular purpose. You are solely responsible for determining 
+ the appropriateness of using or distributing the work and assume all risks 
+ associated with use of this work, including but not limited to the risks and 
+ costs of errors, compliance with applicable laws, damage to or loss of data 
+ or equipment, and unavailability or interruption of operations.
+
+ In no event shall the authors or contributors have any liability for any 
+ direct, indirect, incidental, special, exemplary, or consequential damages,
+ however caused and on any theory of liability, whether in contract, strict 
+ liability, or tort (including negligence), arising in any way out of or in 
+ connection with the use or distribution of the work.
+*****************************************************************************/
+
+dojo.provide(&quot;orp.storage.FileSystem&quot;);
+dojo.require(&quot;orp.storage.Storage&quot;);
+
+// -------------------------------------------------------------------
+// Dependencies, expressed in the syntax that JSLint understands:
+/*global window, document  */
+// -------------------------------------------------------------------
+
+/**
+ * @scope    public function
+ * @param    dirNameRelativeToWindowLocation
+ * @param    suffix                                   // if null or undefined, all files will be listed
+ * @return   an array of the files in the directory
+ * @throws   Throws an Error if directory doesn't exist, isn't a directory, or can't be read.
+ */
+orp.storage.getDirList = function(dirNameRelativeToWindowLocation, suffix) {
+  var dirList = [];
+  var thisUrl = window.location.pathname; // e.g .../someDirectory/currentWindow.html
+  var arrayOfPathComponents = thisUrl.split('/');
+  arrayOfPathComponents.pop();
+  var thisDirectory = arrayOfPathComponents.join('/'); // e.g .../someDirectory
+  if (window.location.protocol == &quot;http:&quot;) {
+    var response = this._getDirListFromPhp(thisDirectory, dirNameRelativeToWindowLocation, suffix);
+    if (response[0] != '[') { // i.e. get_list_of_files_in_dir.php returned a message instead of an array
+      throw new Error(response);
+    }
+    eval(&quot;dirList = &quot; + response);
+  }
+  else {
+    if (window.Components) {
+      dirList = this._getDirListFromMozillaComponent(thisDirectory, dirNameRelativeToWindowLocation, suffix);
+    }
+    else {
+      throw new Error(&quot;window.Components == null&quot;);
+    }
+  }
+  return dirList;
+};
+
+// FIXME: This hack should be replaced by something better, perhaps using dojo.hostenv.getBaseScriptUri().
+orp.storage.PATH_TO_TRUNK_DIRECTORY_FROM_WINDOW_LOCATION = null;
+orp.storage.PATH_TO_WINDOW_LOCATION_FROM_TRUNK_DIRECTORY = null;
+
+orp.storage._getDirListFromPhp = function(thisDirectory, dirNameRelativeToWindowLocation, suffix) {
+  var newXMLHttpRequestObject = new XMLHttpRequest();
+  var pathToTrunkFromPhpFile = &quot;../..&quot;;
+  
+  var dirNameRelativeToPhpFile = pathToTrunkFromPhpFile + '/';
+  if (orp.storage.PATH_TO_WINDOW_LOCATION_FROM_TRUNK_DIRECTORY) {
+    dirNameRelativeToPhpFile += orp.storage.PATH_TO_WINDOW_LOCATION_FROM_TRUNK_DIRECTORY + '/';
+  }
+  dirNameRelativeToPhpFile += dirNameRelativeToWindowLocation;
+  
+  var pathToPhpDirectoryFromWindowLocation = &quot;&quot;;
+  if (orp.storage.PATH_TO_TRUNK_DIRECTORY_FROM_WINDOW_LOCATION) {
+    pathToPhpDirectoryFromWindowLocation += orp.storage.PATH_TO_TRUNK_DIRECTORY_FROM_WINDOW_LOCATION + '/';
+  }
+  pathToPhpDirectoryFromWindowLocation += orp.storage.PATH_TO_PHP_FILES_FROM_TRUNK + '/';
+
+  var pathToPhpFileFromWindowLocation = pathToPhpDirectoryFromWindowLocation + &quot;get_list_of_files_in_dir.php&quot;;
+  var url = thisDirectory + '/' + pathToPhpFileFromWindowLocation + 
+            &quot;?dir=&quot; + dirNameRelativeToPhpFile;
+  if (suffix) {
+    url += &quot;&amp;suffix=&quot; + suffix;
+  }
+  newXMLHttpRequestObject.open(&quot;GET&quot;, url, false);
+  newXMLHttpRequestObject.send(null);
+  return newXMLHttpRequestObject.responseText;
+};
+
+orp.storage._getDirListFromMozillaComponent = function(thisDirectory, dirNameRelativeToWindowLocation, suffix) {
+  var dirList = [];
+  netscape.security.PrivilegeManager.enablePrivilege(&quot;UniversalXPConnect&quot;);
+  var file = Components.classes[&quot;@mozilla.org/file/local;1&quot;].createInstance(Components.interfaces.nsILocalFile);
+  var dirPath = thisDirectory + &quot;/&quot; + dirNameRelativeToWindowLocation;
+  file.initWithPath(dirPath);
+  if (!file.exists()) {
+    throw new Error(dirPath + &quot; not found.&quot;);
+  }
+  if (!file.isDirectory()) {
+    throw new Error(dirPath + &quot; is not a directory.&quot;);
+  }
+  // file is the given directory (nsIFile)
+  var entries = file.directoryEntries;
+  while(entries.hasMoreElements()) {
+    var entry = entries.getNext();
+    entry.QueryInterface(Components.interfaces.nsIFile);
+    if (suffix) {
+      var parts = entry.leafName.split('.');
+      if (parts.length != 2 || parts[1] != suffix) {
+        continue;
+      }
+    }
+    dirList.push(entry.leafName); // could be entry.path instead, if needed...
+  }
+  return dirList;
+};
+
+// -------------------------------------------------------------------
+// End of file
+// -------------------------------------------------------------------

Modified: trunk/source/storage/HttpStorage.js
===================================================================
--- trunk/source/storage/HttpStorage.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/storage/HttpStorage.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -47,8 +47,8 @@
  * @param    pathToTrunkDirectoryFromWindowLocation // Not needed if window location is at the root of the trunk directory.
  * @scope    public instance constructor
  */
-orp.storage.HttpStorage = function(repositoryName, pathToTrunkDirectoryFromWindowLocation) {
-  orp.storage.Storage.call(this, repositoryName, pathToTrunkDirectoryFromWindowLocation);
+orp.storage.HttpStorage = function(repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromWindowLocation) {
+  orp.storage.Storage.call(this, repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromWindowLocation);
 
   var thisUrl = window.location.pathname; //e.g. /openrecord/trunk/demo_page.html or /openrecord/trunk/source/model/TestRepositoryWriting.html.
   var arrayOfPathComponents = thisUrl.split('/');
@@ -75,7 +75,9 @@
  */
 orp.storage.HttpStorage.prototype.appendText = function(textToAppend) {
   var url = this._completePathToTrunkDirectory;
-  url += &quot;/source/storage/append_to_repository_file.php?file=&quot; + this.getRepositoryName();
+  url += '/' + orp.storage.PATH_TO_PHP_FILES_FROM_TRUNK;
+  // FIXME: Should also pass in this._repositoryDirectoryName, rather than having &quot;repositories&quot; hardcoded in append_to_repository_file.php.
+  url += &quot;/append_to_repository_file.php?file=&quot; + this.getRepositoryName();
   
   // PENDING: 
   // It might be more efficient to re-use the XMLHttpRequestObject,
@@ -98,7 +100,9 @@
  */
 orp.storage.HttpStorage.prototype.writeText = function(textToWrite, overwriteIfExists) {
   var url = this._completePathToTrunkDirectory;
-  url += &quot;/source/storage/write_to_repository_file.php?file=&quot; + this.getRepositoryName();
+  url += '/' + orp.storage.PATH_TO_PHP_FILES_FROM_TRUNK;
+  // FIXME: Should also pass in this._repositoryDirectoryName, rather than having &quot;repositories&quot; hardcoded in write_to_repository_file.php.
+  url += &quot;/write_to_repository_file.php?file=&quot; + this.getRepositoryName();
   if (overwriteIfExists) {
     url += &quot;&amp;overwrite=T&quot;;
   }

Modified: trunk/source/storage/Storage.js
===================================================================
--- trunk/source/storage/Storage.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/storage/Storage.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -46,11 +46,16 @@
  * @param    pathToTrunkDirectoryFromWindowLocation // Not needed if window location is at the root of the trunk directory.
  * @scope    public instance constructor
  */
-orp.storage.Storage = function(repositoryName, pathToTrunkDirectoryFromWindowLocation) {
+orp.storage.Storage = function(repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromWindowLocation) {
   this._repositoryName = repositoryName;
+  this._repositoryDirectoryName = repositoryDirectoryName;
   this._pathToTrunkDirectory = pathToTrunkDirectoryFromWindowLocation;
 };
 
+// -------------------------------------------------------------------
+// Public constants
+// -------------------------------------------------------------------
+orp.storage.PATH_TO_PHP_FILES_FROM_TRUNK = &quot;source/storage&quot;;
 
 // -------------------------------------------------------------------
 // Public methods

Added: trunk/source/storage/get_list_of_files_in_dir.php
===================================================================
--- trunk/source/storage/get_list_of_files_in_dir.php	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/source/storage/get_list_of_files_in_dir.php	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,25 @@
+&lt;?php
+$url_of_this_php_script = $_SERVER['REQUEST_URI'];
+$dir = $_GET['dir'];
+$suffix_specified = array_key_exists('suffix', $_GET);
+if ($suffix_specified) {
+  $suffix = $_GET['suffix'];
+}
+if (!file_exists($dir)) {
+  exit(&quot;$dir not found.&quot;); 
+}
+;
+if (!($dh = opendir($dir))) {
+  exit(&quot;Could not open $dir.&quot;); 
+}
+while (false !== ($filename = readdir($dh))) {
+  if ($filename == &quot;.&quot; || $filename == &quot;..&quot;) {
+    continue;
+  }
+  $array_of_file_name_parts = explode(&quot;.&quot;, $filename);
+  if (!$suffix_specified || $array_of_file_name_parts[1] == $suffix) {
+    $array_js[] = &quot;\&quot;&quot; . $filename . &quot;\&quot;&quot;;
+  }
+}
+echo &quot;[&quot; . implode(',', $array_js) . &quot;]&quot;;
+?&gt;

Modified: trunk/tests/LintTest.js
===================================================================
--- trunk/tests/LintTest.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/LintTest.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -34,7 +34,7 @@
 // -------------------------------------------------------------------
 
 function setUp() {
-  dojo.hostenv.setModulePrefix(&quot;dojo&quot;, &quot;../../../../dojo/dojo-0.1.0/src&quot;);
+  dojo.hostenv.setModulePrefix(&quot;dojo&quot;, &quot;../../../../dojo/dojo-rev1759/src&quot;);
   dojo.hostenv.setModulePrefix(&quot;orp&quot;, &quot;../../../../../source&quot;);
   dojo.require(&quot;orp.util.LintTool&quot;);
 }

Modified: trunk/tests/TestSuite.html
===================================================================
--- trunk/tests/TestSuite.html	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/TestSuite.html	2005-10-25 03:17:18 UTC (rev 367)
@@ -31,7 +31,7 @@
         testSuite.addTestPage(&quot;../../../tests/uuid/TestSuite.html&quot;);
         testSuite.addTestPage(&quot;../../../tests/model/TestSuite.html&quot;);
         testSuite.addTestPage(&quot;../../../tests/archive/LintTest.html&quot;);
-        testSuite.addTestPage(&quot;../../../tests/storage/LintTest.html&quot;);
+        testSuite.addTestPage(&quot;../../../tests/storage/TestSuite.html&quot;);
         testSuite.addTestPage(&quot;../../../tests/view/LintTest.html&quot;);
         testSuite.addTestPage(&quot;../../../tests/LintTest.html&quot;);
         return testSuite;

Modified: trunk/tests/model/RepositoryWritingTest.js
===================================================================
--- trunk/tests/model/RepositoryWritingTest.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/model/RepositoryWritingTest.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -30,7 +30,6 @@
 var pathToTrunkDirectoryFromThisDirectory   = &quot;../..&quot;;
 var fileName = &quot;FakeRepository&quot;;
 var fileUrl;
-var saver;
 var expectedRepositoryHeader = '{ &quot;format&quot;: &quot;2005_JUNE_CHRONOLOGICAL_LIST&quot;, \n';
 expectedRepositoryHeader +=    '  &quot;records&quot;: [\n';
 expectedRepositoryHeader +=    '  // =======================================================================\n';
@@ -50,10 +49,6 @@
   utilAssertReportedError = false;
   orp.util.setErrorReportCallback(errorReporter)
 
-  var isHttp = window.location.protocol == &quot;http:&quot;;
-  saver = isHttp? new orp.storage.HttpStorage(fileName, pathToTrunkDirectoryFromThisDirectory) 
-                : new orp.storage.FileStorage(fileName, pathToTrunkDirectoryFromThisDirectory);
-
   // Examples of what window.location.pathname should look like:
   // for http: protocol: /openrecord/trunk/source/model/TestRepositoryWriting.html
   // for file: protocol on a Mac: /Libraries/.../openrecord/trunk/source/model/TestRepositoryWriting.html
@@ -65,7 +60,9 @@
 
   // fileUrl must specify a file /repositories/*.json relative to the trunk directory, because
   // that's where FileSaver and HttpSaver will write
-  fileUrl = thisDirectory + '/' + pathToTrunkDirectoryFromThisDirectory + &quot;/repositories/&quot; + fileName + &quot;.json&quot;;
+  fileUrl = thisDirectory + '/' + pathToTrunkDirectoryFromThisDirectory
+                          + '/' + orp.archive.DeltaArchive.PATH_TO_REPOSITORY_DIRECTORY
+                          + '/' + fileName + &quot;.json&quot;;
 }
 
 function tearDown() {
@@ -77,37 +74,6 @@
 // Test functions
 // -------------------------------------------------------------------
 
-function testCreateNewFile() {
-  var now = new Date();
-  var timestamp = now.toString() + &quot; &quot; + now.valueOf();
-  var overwriteIfExists = true;
-  saver.writeText(timestamp, overwriteIfExists);
-  assertTrue(&quot;Contents should be timestamp.&quot;, fileHasExpectedContents(timestamp));
-}
-
-function testOverwriteFile() {
-  var overwriteIfExists = true;
-  saver.writeText(&quot;123&quot;, overwriteIfExists);
-  assertTrue(&quot;Contents should be '123'.&quot;, fileHasExpectedContents('123'));
-  var now = new Date();
-  var timestamp = now.toString() + &quot; &quot; + now.valueOf();
-  saver.writeText(timestamp, overwriteIfExists);
-  assertTrue(&quot;Contents should be timestamp.&quot;, fileHasExpectedContents(timestamp));
-}
-
-function testAppendToFile() {
-  var now = new Date();
-  var timestamp1 = now.toString() + &quot; &quot; + now.valueOf();
-  var overwriteIfExists = true;
-  saver.writeText(timestamp1, overwriteIfExists);
-  assertTrue(&quot;Contents should be timestamp1.&quot;, fileHasExpectedContents(timestamp1));
-  now = new Date();
-  var timestamp2 = now.toString() + &quot; &quot; + now.valueOf();
-  saver.appendText(&quot;\n&quot; + timestamp2);
-  var expectedContents = timestamp1 + &quot;\n&quot; + timestamp2;
-  assertTrue(&quot;Contents should be timestamp1 &amp; timestamp2.&quot;, fileHasExpectedContents(expectedContents));
-}
-
 function testCreateNewRepository() {
   var archive = new orp.archive.DeltaArchive(fileName, pathToTrunkDirectoryFromThisDirectory);
   var overwriteIfExists = true;

Added: trunk/tests/storage/DirectoryReadingTest.html
===================================================================
--- trunk/tests/storage/DirectoryReadingTest.html	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/DirectoryReadingTest.html	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,74 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot; xml:lang=&quot;en&quot; &gt;
+
+&lt;!-- 
+ Copyright rights relinquished under the Creative Commons  
+ Public Domain Dedication:
+    <A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>
+--&gt;
+
+  &lt;head&gt;
+    &lt;title&gt;Test reading directories&lt;/title&gt;
+
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/jsunit/jsunit2_1/app/jsUnitCore.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/dojo/dojo-0.1.0/dojo.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/md5/md5.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;DirectoryReadingTest.js&quot;&gt;&lt;/script&gt;
+  &lt;/head&gt;
+  
+  &lt;body&gt;
+    &lt;h1&gt;Test reading directories&lt;/h1&gt;
+
+    &lt;p&gt;This page is used to run unit tests for the JavaScript code in the 
+    OpenRecord project.&lt;/p&gt;
+    
+    &lt;p&gt;&nbsp;&lt;/p&gt;
+    &lt;hr/&gt;
+    &lt;p&gt;You should be able to run these unit tests by going to
+    &lt;a href=&quot;../../third_party/jsunit/jsunit2_1/testRunner.html?testpage=&quot; 
+    onclick=&quot;href+=window.location.href;&quot; rel=&quot;external&quot;&gt;the local testRunner 
+    page&lt;/a&gt;, and hitting the &lt;b&gt;Run&lt;/b&gt; button.&lt;/p&gt;
+
+    &lt;p&gt;To see the tests, open this .html file in a text editor. Or, within a  
+    web browser, you should be able see the source for this file by using 
+    some menu like &lt;b&gt;View&lt;/b&gt; followed by &lt;b&gt;Page Source&lt;/b&gt;. The tests 
+    may be in this file, or they may be in a separate file that has the
+    same name as this one, except with a .js extension instead of a .html
+    extension.&lt;/p&gt;
+ 
+    &lt;p&gt;The unit tests are set up to run in the
+    &lt;a href=&quot;<A HREF="http://www.edwardh.com/jsunit/">http://www.edwardh.com/jsunit/</A>&quot; rel=&quot;external&quot;&gt;JsUnit framework&lt;/a&gt;
+    written by 
+    &lt;a href=&quot;<A HREF="http://www.edwardh.com/">http://www.edwardh.com/</A>&quot; rel=&quot;external&quot;&gt;Edward Hieatt&lt;/a&gt;. &lt;/p&gt;
+
+    &lt;p&gt;&nbsp;&lt;/p&gt;
+    &lt;hr/&gt;
+    &lt;p class=&quot;copyright&quot;&gt;You can copy freely from this work &mdash; copyright 
+    rights relinquished under the Creative Commons  
+    &lt;a rel=&quot;license external&quot; 
+    href=&quot;<A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>&quot;&gt;Public Domain 
+    Dedication&lt;/a&gt;.&lt;/p&gt;
+
+&lt;!-- Creative Commons metadata for Public Domain License 
+
+&lt;rdf:RDF xmlns=&quot;<A HREF="http://web.resource.org/cc/">http://web.resource.org/cc/</A>&quot;
+    xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+    xmlns:rdf=&quot;<A HREF="http://www.w3.org/1999/02/22-rdf-syntax-ns#">http://www.w3.org/1999/02/22-rdf-syntax-ns#</A>&quot;&gt;
+&lt;Work rdf:about=&quot;&quot;&gt;
+   &lt;dc:title&gt;openrecord.org&lt;/dc:title&gt;
+   &lt;dc:type rdf:resource=&quot;<A HREF="http://purl.org/dc/dcmitype/Text">http://purl.org/dc/dcmitype/Text</A>&quot; /&gt;
+   &lt;license rdf:resource=&quot;<A HREF="http://web.resource.org/cc/PublicDomain">http://web.resource.org/cc/PublicDomain</A>&quot; /&gt;
+&lt;/Work&gt;
+
+&lt;License rdf:about=&quot;<A HREF="http://web.resource.org/cc/PublicDomain">http://web.resource.org/cc/PublicDomain</A>&quot;&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/Reproduction">http://web.resource.org/cc/Reproduction</A>&quot; /&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/Distribution">http://web.resource.org/cc/Distribution</A>&quot; /&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/DerivativeWorks">http://web.resource.org/cc/DerivativeWorks</A>&quot; /&gt;
+&lt;/License&gt;
+
+&lt;/rdf:RDF&gt;
+
+--&gt;
+  &lt;/body&gt;
+&lt;/html&gt;

Added: trunk/tests/storage/DirectoryReadingTest.js
===================================================================
--- trunk/tests/storage/DirectoryReadingTest.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/DirectoryReadingTest.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,84 @@
+/*****************************************************************************
+ DirectoryReadingTest.js
+ 
+******************************************************************************
+ Written in 2005 by Mignon Belongie
+
+ Copyright rights relinquished under the Creative Commons  
+ Public Domain Dedication:
+    <A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>
+  
+ You can copy freely from this file.  This work may be freely reproduced, 
+ distributed, transmitted, used, modified, built upon, or otherwise exploited
+ by anyone for any purpose.
+  
+ This work is provided on an &quot;AS IS&quot; basis, without warranties or conditions 
+ of any kind, either express or implied, including, without limitation, any 
+ warranties or conditions of title, non-infringement, merchantability, or 
+ fitness for a particular purpose. You are solely responsible for determining 
+ the appropriateness of using or distributing the work and assume all risks 
+ associated with use of this work, including but not limited to the risks and 
+ costs of errors, compliance with applicable laws, damage to or loss of data 
+ or equipment, and unavailability or interruption of operations.
+
+ In no event shall the authors or contributors have any liability for any 
+ direct, indirect, incidental, special, exemplary, or consequential damages,
+ however caused and on any theory of liability, whether in contract, strict 
+ liability, or tort (including negligence), arising in any way out of or in 
+ connection with the use or distribution of the work.
+*****************************************************************************/
+
+// -------------------------------------------------------------------
+// setUp and tearDown
+// -------------------------------------------------------------------
+
+function setUp() {
+  dojo.hostenv.setModulePrefix(&quot;dojo&quot;, &quot;../../../dojo/dojo-0.1.0/src&quot;);
+  dojo.hostenv.setModulePrefix(&quot;orp&quot;, &quot;../../../../source&quot;);
+  dojo.require(&quot;orp.storage.FileSystem&quot;);
+  dojo.require(&quot;orp.util.Util&quot;);
+  orp.storage.PATH_TO_TRUNK_DIRECTORY_FROM_WINDOW_LOCATION = &quot;../..&quot;;
+  orp.storage.PATH_TO_WINDOW_LOCATION_FROM_TRUNK_DIRECTORY = &quot;tests/storage&quot;;
+}
+
+function tearDown() {
+}
+
+// -------------------------------------------------------------------
+// Test functions
+// -------------------------------------------------------------------
+
+function testGetDirListWithSuffix() {
+  var dirList = orp.storage.getDirList(&quot;directory_1/subdirectory_1&quot;, &quot;js&quot;);
+  assertTrue(&quot;List should include 'javascript_file_1.js'.&quot;, orp.util.isObjectInSet(&quot;javascript_file_1.js&quot;, dirList));
+  assertTrue(&quot;List should include 'javascript_file_2.js'.&quot;, orp.util.isObjectInSet(&quot;javascript_file_2.js&quot;, dirList));
+  assertTrue(&quot;List should include exactly two files.&quot;, dirList.length == 2);
+}
+
+function testGetDirListWithoutSuffix() {
+  var dirList = orp.storage.getDirList(&quot;directory_1/subdirectory_1&quot;);
+  assertTrue(&quot;List should include 'suffixless_file_1'.&quot;, orp.util.isObjectInSet(&quot;suffixless_file_1&quot;, dirList));
+  assertTrue(&quot;List should include 'javascript_file_2.js'.&quot;, orp.util.isObjectInSet(&quot;javascript_file_2.js&quot;, dirList));
+  assertTrue(&quot;List should include 'text_file_1.txt'.&quot;, orp.util.isObjectInSet(&quot;text_file_1.txt&quot;, dirList));
+  assertTrue(&quot;List should include exactly six files.&quot;, dirList.length == 6);
+}
+
+function testGetDirListForMissingDir() {
+  var exceptionCaught = false;
+  try {
+    var dirList = orp.storage.getDirList(&quot;nonexistent&quot;);
+  }
+  catch (exception) {
+    exceptionCaught = true;
+  }
+  assertTrue(&quot;Exception should have been caught.&quot;, exceptionCaught);    
+}
+
+// -------------------------------------------------------------------
+// Helper functions
+// -------------------------------------------------------------------
+
+
+// -------------------------------------------------------------------
+// End of file
+// -------------------------------------------------------------------

Modified: trunk/tests/storage/LintTest.js
===================================================================
--- trunk/tests/storage/LintTest.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/LintTest.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -58,7 +58,8 @@
     &quot;Storage.js&quot;,
     &quot;FakeStorage.js&quot;,
     &quot;FileStorage.js&quot;,
-    &quot;HttpStorage.js&quot;];
+    &quot;HttpStorage.js&quot;,
+    &quot;FileSystem.js&quot;];
   var prefix = &quot;../../../source/storage/&quot;;
   var errorReport = orp.util.LintTool.getErrorReportFromListOfFilesnames(listOfSourceCodeFiles, prefix);
   var message = &quot;Lint check \n&quot; + errorReport;

Added: trunk/tests/storage/StorageTest.html
===================================================================
--- trunk/tests/storage/StorageTest.html	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/StorageTest.html	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,75 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot; xml:lang=&quot;en&quot; &gt;
+
+&lt;!-- 
+ Copyright rights relinquished under the Creative Commons  
+ Public Domain Dedication:
+    <A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>
+--&gt;
+
+  &lt;head&gt;
+    &lt;title&gt;Test writing to repositories&lt;/title&gt;
+
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/jsunit/jsunit2_1/app/jsUnitCore.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/dojo/dojo-rev1759/dojo.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/md5/md5.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot; src=&quot;StorageTest.js&quot;&gt;&lt;/script&gt;
+  &lt;/head&gt;
+  
+  &lt;body&gt;
+    &lt;h1&gt;Test writing to repositories.&lt;/h1&gt;
+
+    &lt;p&gt;This page is used to run unit tests for the JavaScript code in the 
+    OpenRecord project.&lt;/p&gt;
+    
+    &lt;p&gt;&nbsp;&lt;/p&gt;
+    &lt;hr/&gt;
+    &lt;p&gt;You should be able to run these unit tests by going to
+    &lt;a href=&quot;../../third_party/jsunit/jsunit2_1/testRunner.html?testpage=&quot; 
+    onclick=&quot;href+=window.location.href;&quot; rel=&quot;external&quot;&gt;the local testRunner 
+    page&lt;/a&gt;, and hitting the &lt;b&gt;Run&lt;/b&gt; button.&lt;/p&gt;
+
+    &lt;p&gt;To see the tests, open this .html file in a text editor. Or, within a  
+    web browser, you should be able see the source for this file by using 
+    some menu like &lt;b&gt;View&lt;/b&gt; followed by &lt;b&gt;Page Source&lt;/b&gt;. The tests 
+    may be in this file, or they may be in a separate file that has the
+    same name as this one, except with a .js extension instead of a .html
+    extension.&lt;/p&gt;
+ 
+    &lt;p&gt;The unit tests are set up to run in the
+    &lt;a href=&quot;<A HREF="http://www.edwardh.com/jsunit/">http://www.edwardh.com/jsunit/</A>&quot; rel=&quot;external&quot;&gt;JsUnit framework&lt;/a&gt;
+    written by 
+    &lt;a href=&quot;<A HREF="http://www.edwardh.com/">http://www.edwardh.com/</A>&quot; rel=&quot;external&quot;&gt;Edward Hieatt&lt;/a&gt;. &lt;/p&gt;
+
+    &lt;p&gt;&nbsp;&lt;/p&gt;
+    &lt;hr/&gt;
+    &lt;p class=&quot;copyright&quot;&gt;You can copy freely from this work &mdash; copyright 
+    rights relinquished under the Creative Commons  
+    &lt;a rel=&quot;license external&quot; 
+    href=&quot;<A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>&quot;&gt;Public Domain 
+    Dedication&lt;/a&gt;.&lt;/p&gt;
+
+&lt;!-- Creative Commons metadata for Public Domain License 
+
+&lt;rdf:RDF xmlns=&quot;<A HREF="http://web.resource.org/cc/">http://web.resource.org/cc/</A>&quot;
+    xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+    xmlns:rdf=&quot;<A HREF="http://www.w3.org/1999/02/22-rdf-syntax-ns#">http://www.w3.org/1999/02/22-rdf-syntax-ns#</A>&quot;&gt;
+&lt;Work rdf:about=&quot;&quot;&gt;
+   &lt;dc:title&gt;openrecord.org&lt;/dc:title&gt;
+   &lt;dc:type rdf:resource=&quot;<A HREF="http://purl.org/dc/dcmitype/Text">http://purl.org/dc/dcmitype/Text</A>&quot; /&gt;
+   &lt;license rdf:resource=&quot;<A HREF="http://web.resource.org/cc/PublicDomain">http://web.resource.org/cc/PublicDomain</A>&quot; /&gt;
+&lt;/Work&gt;
+
+&lt;License rdf:about=&quot;<A HREF="http://web.resource.org/cc/PublicDomain">http://web.resource.org/cc/PublicDomain</A>&quot;&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/Reproduction">http://web.resource.org/cc/Reproduction</A>&quot; /&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/Distribution">http://web.resource.org/cc/Distribution</A>&quot; /&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/DerivativeWorks">http://web.resource.org/cc/DerivativeWorks</A>&quot; /&gt;
+&lt;/License&gt;
+
+&lt;/rdf:RDF&gt;
+
+--&gt;
+  &lt;/body&gt;
+&lt;/html&gt;
+

Added: trunk/tests/storage/StorageTest.js
===================================================================
--- trunk/tests/storage/StorageTest.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/StorageTest.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,151 @@
+/*****************************************************************************
+ StorageTest.js
+ 
+******************************************************************************
+ Copyright rights relinquished under the Creative Commons  
+ Public Domain Dedication:
+    <A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>
+  
+ You can copy freely from this file.  This work may be freely reproduced, 
+ distributed, transmitted, used, modified, built upon, or otherwise exploited
+ by anyone for any purpose.
+  
+ This work is provided on an &quot;AS IS&quot; basis, without warranties or conditions 
+ of any kind, either express or implied, including, without limitation, any 
+ warranties or conditions of title, non-infringement, merchantability, or 
+ fitness for a particular purpose. You are solely responsible for determining 
+ the appropriateness of using or distributing the work and assume all risks 
+ associated with use of this work, including but not limited to the risks and 
+ costs of errors, compliance with applicable laws, damage to or loss of data 
+ or equipment, and unavailability or interruption of operations.
+
+ In no event shall the authors or contributors have any liability for any 
+ direct, indirect, incidental, special, exemplary, or consequential damages,
+ however caused and on any theory of liability, whether in contract, strict 
+ liability, or tort (including negligence), arising in any way out of or in 
+ connection with the use or distribution of the work.
+*****************************************************************************/
+
+var utilAssertReportedError;
+var pathToTrunkDirectoryFromThisDirectory   = &quot;../..&quot;;
+var repositoryName = &quot;FakeRepository&quot;;
+var repositoryDirectoryName = &quot;repositories&quot;;
+var fileUrl;
+var saver;
+
+// -------------------------------------------------------------------
+// setUp and tearDown
+// -------------------------------------------------------------------
+
+function setUp() {
+  dojo.hostenv.setModulePrefix(&quot;dojo&quot;, &quot;../../../dojo/dojo-rev1759/src&quot;);
+  dojo.hostenv.setModulePrefix(&quot;orp&quot;, &quot;../../../../source&quot;);
+  dojo.require(&quot;orp.util.Util&quot;);
+  dojo.require(&quot;orp.storage.FileStorage&quot;);
+  dojo.require(&quot;orp.storage.HttpStorage&quot;);
+
+  utilAssertReportedError = false;
+  orp.util.setErrorReportCallback(errorReporter)
+
+  var isHttp = window.location.protocol == &quot;http:&quot;;
+  saver = isHttp? new orp.storage.HttpStorage(repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromThisDirectory) 
+                : new orp.storage.FileStorage(repositoryName, repositoryDirectoryName, pathToTrunkDirectoryFromThisDirectory);
+
+  // Examples of what window.location.pathname should look like:
+  // for http: protocol: /openrecord/trunk/source/model/TestRepositoryWriting.html
+  // for file: protocol on a Mac: /Libraries/.../openrecord/trunk/source/model/TestRepositoryWriting.html
+  // for file: protocol on a PC:  /C:/Documents and Settings/.../source/model/TestRepositoryWriting.html
+  var thisUrl = window.location.pathname;
+  var arrayOfPathComponents = thisUrl.split('/');
+  arrayOfPathComponents.pop();
+  var thisDirectory = arrayOfPathComponents.join('/'); //e.g. /openrecord/trunk/source/model
+
+  // fileUrl must specify a file /repositories/*.json relative to the trunk directory, because
+  // that's where FileSaver and HttpSaver will write
+  fileUrl = thisDirectory + '/' + pathToTrunkDirectoryFromThisDirectory
+                          + '/' + repositoryDirectoryName
+                          + '/' + repositoryName + &quot;.json&quot;;
+}
+
+function tearDown() {
+  assertFalse(utilAssertReportedError);
+}
+
+
+// -------------------------------------------------------------------
+// Test functions
+// -------------------------------------------------------------------
+
+function testCreateNewFile() {
+  var now = new Date();
+  var timestamp = now.toString() + &quot; &quot; + now.valueOf();
+  var overwriteIfExists = true;
+  saver.writeText(timestamp, overwriteIfExists);
+  assertTrue(&quot;Contents should be timestamp.&quot;, fileHasExpectedContents(timestamp));
+}
+
+function testOverwriteFile() {
+  var overwriteIfExists = true;
+  saver.writeText(&quot;123&quot;, overwriteIfExists);
+  assertTrue(&quot;Contents should be '123'.&quot;, fileHasExpectedContents('123'));
+  var now = new Date();
+  var timestamp = now.toString() + &quot; &quot; + now.valueOf();
+  saver.writeText(timestamp, overwriteIfExists);
+  assertTrue(&quot;Contents should be timestamp.&quot;, fileHasExpectedContents(timestamp));
+}
+
+function testAppendToFile() {
+  var now = new Date();
+  var timestamp1 = now.toString() + &quot; &quot; + now.valueOf();
+  var overwriteIfExists = true;
+  saver.writeText(timestamp1, overwriteIfExists);
+  assertTrue(&quot;Contents should be timestamp1.&quot;, fileHasExpectedContents(timestamp1));
+  now = new Date();
+  var timestamp2 = now.toString() + &quot; &quot; + now.valueOf();
+  saver.appendText(&quot;\n&quot; + timestamp2);
+  var expectedContents = timestamp1 + &quot;\n&quot; + timestamp2;
+  assertTrue(&quot;Contents should be timestamp1 &amp; timestamp2.&quot;, fileHasExpectedContents(expectedContents));
+}
+
+// -------------------------------------------------------------------
+// Helper functions
+// -------------------------------------------------------------------
+
+function errorReporter() {
+  utilAssertReportedError = true;
+}
+
+function waitASecond() {
+  var now = new Date();
+  var then = now;
+  while (now.valueOf() - then.valueOf() &lt; 1000) {
+    now = new Date();
+  }
+}
+
+function fileHasExpectedContents(expectedContents) {
+  // var contents = orp.util.getStringContentsOfFileAtURL(fileUrl);
+  var contents = dojo.hostenv.getText(fileUrl);
+  for (var i = 0; contents != expectedContents &amp;&amp; i &lt; 5; ++i) {
+    waitASecond();
+    // contents = orp.util.getStringContentsOfFileAtURL(fileUrl);
+    contents = dojo.hostenv.getText(fileUrl);
+  }
+  return (contents == expectedContents);
+}
+
+function fileHasExpectedSubstring(expectedSubstring) {
+  // var contents = orp.util.getStringContentsOfFileAtURL(fileUrl);
+  var contents = dojo.hostenv.getText(fileUrl);
+  for (var i = 0; contents.indexOf(expectedSubstring) == -1 &amp;&amp; i &lt; 5; ++i) {
+    waitASecond();
+    // contents = orp.util.getStringContentsOfFileAtURL(fileUrl);
+    contents = dojo.hostenv.getText(fileUrl);
+  }
+  return (contents.indexOf(expectedSubstring) != -1);
+}
+
+
+// -------------------------------------------------------------------
+// End of file
+// -------------------------------------------------------------------

Added: trunk/tests/storage/TestSuite.html
===================================================================
--- trunk/tests/storage/TestSuite.html	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/TestSuite.html	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,88 @@
+&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
+&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.1//EN&quot; &quot;<A HREF="http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd</A>&quot;&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot; xml:lang=&quot;en&quot; &gt;
+
+&lt;!-- 
+ Written in 2005 by Mignon Belongie
+  
+ Copyright rights relinquished under the Creative Commons  
+ Public Domain Dedication:
+    <A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>
+--&gt;
+
+  &lt;head&gt;
+    &lt;title&gt;Storage Test Suite&lt;/title&gt;
+
+    &lt;script type=&quot;text/javascript&quot; src=&quot;../../third_party/jsunit/jsunit2_1/app/jsUnitCore.js&quot;&gt;&lt;/script&gt;
+    &lt;script type=&quot;text/javascript&quot;&gt;
+      function suite() {
+        var testSuite = new window.top.jsUnitTestSuite();
+        testSuite.addTestSuite(storageTestSuite());
+        return testSuite;
+      }
+      
+      function storageTestSuite() {
+        var testSuite = new window.top.jsUnitTestSuite();
+        testSuite.addTestPage(&quot;../../../tests/storage/StorageTest.html&quot;);
+        testSuite.addTestPage(&quot;../../../tests/storage/DirectoryReadingTest.html&quot;);
+        testSuite.addTestPage(&quot;../../../tests/storage/LintTest.html&quot;);
+        return testSuite;
+      }
+    &lt;/script&gt;
+  &lt;/head&gt;
+  
+  &lt;body&gt;
+    &lt;h1&gt;Storage Test Suite&lt;/h1&gt;
+
+    &lt;p&gt;This page is used to run unit tests for the JavaScript code in the 
+    OpenRecord project.&lt;/p&gt;
+    
+    &lt;p&gt;&nbsp;&lt;/p&gt;
+    &lt;hr/&gt;
+    &lt;p&gt;You should be able to run these unit tests by going to
+    &lt;a href=&quot;../../third_party/jsunit/jsunit2_1/testRunner.html?testpage=&quot; 
+    onclick=&quot;href+=window.location.href;&quot; rel=&quot;external&quot;&gt;the local testRunner 
+    page&lt;/a&gt;, and hitting the &lt;b&gt;Run&lt;/b&gt; button.&lt;/p&gt;
+
+    &lt;p&gt;To see the tests, open this .html file in a text editor. Or, within a  
+    web browser, you should be able see the source for this file by using 
+    some menu like &lt;b&gt;View&lt;/b&gt; followed by &lt;b&gt;Page Source&lt;/b&gt;. The tests 
+    may be in this file, or they may be in a separate file that has the
+    same name as this one, except with a .js extension instead of a .html
+    extension.&lt;/p&gt;
+ 
+    &lt;p&gt;The unit tests are set up to run in the
+    &lt;a href=&quot;<A HREF="http://www.edwardh.com/jsunit/">http://www.edwardh.com/jsunit/</A>&quot; rel=&quot;external&quot;&gt;JsUnit framework&lt;/a&gt;
+    written by 
+    &lt;a href=&quot;<A HREF="http://www.edwardh.com/">http://www.edwardh.com/</A>&quot; rel=&quot;external&quot;&gt;Edward Hieatt&lt;/a&gt;. &lt;/p&gt;
+
+    &lt;p&gt;&nbsp;&lt;/p&gt;
+    &lt;hr/&gt;
+    &lt;p class=&quot;copyright&quot;&gt;You can copy freely from this work &mdash; copyright 
+    rights relinquished under the Creative Commons  
+    &lt;a rel=&quot;license external&quot; 
+    href=&quot;<A HREF="http://creativecommons.org/licenses/publicdomain/">http://creativecommons.org/licenses/publicdomain/</A>&quot;&gt;Public Domain 
+    Dedication&lt;/a&gt;.&lt;/p&gt;
+
+&lt;!-- Creative Commons metadata for Public Domain License 
+
+&lt;rdf:RDF xmlns=&quot;<A HREF="http://web.resource.org/cc/">http://web.resource.org/cc/</A>&quot;
+    xmlns:dc=&quot;<A HREF="http://purl.org/dc/elements/1.1/">http://purl.org/dc/elements/1.1/</A>&quot;
+    xmlns:rdf=&quot;<A HREF="http://www.w3.org/1999/02/22-rdf-syntax-ns#">http://www.w3.org/1999/02/22-rdf-syntax-ns#</A>&quot;&gt;
+&lt;Work rdf:about=&quot;&quot;&gt;
+   &lt;dc:title&gt;openrecord.org&lt;/dc:title&gt;
+   &lt;dc:type rdf:resource=&quot;<A HREF="http://purl.org/dc/dcmitype/Text">http://purl.org/dc/dcmitype/Text</A>&quot; /&gt;
+   &lt;license rdf:resource=&quot;<A HREF="http://web.resource.org/cc/PublicDomain">http://web.resource.org/cc/PublicDomain</A>&quot; /&gt;
+&lt;/Work&gt;
+
+&lt;License rdf:about=&quot;<A HREF="http://web.resource.org/cc/PublicDomain">http://web.resource.org/cc/PublicDomain</A>&quot;&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/Reproduction">http://web.resource.org/cc/Reproduction</A>&quot; /&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/Distribution">http://web.resource.org/cc/Distribution</A>&quot; /&gt;
+   &lt;permits rdf:resource=&quot;<A HREF="http://web.resource.org/cc/DerivativeWorks">http://web.resource.org/cc/DerivativeWorks</A>&quot; /&gt;
+&lt;/License&gt;
+
+&lt;/rdf:RDF&gt;
+
+--&gt;
+  &lt;/body&gt;
+&lt;/html&gt;

Added: trunk/tests/storage/directory_1/subdirectory_1/javascript_file_1.js
===================================================================
--- trunk/tests/storage/directory_1/subdirectory_1/javascript_file_1.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/directory_1/subdirectory_1/javascript_file_1.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,2 @@
+line 1
+

Added: trunk/tests/storage/directory_1/subdirectory_1/javascript_file_2.js
===================================================================
--- trunk/tests/storage/directory_1/subdirectory_1/javascript_file_2.js	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/directory_1/subdirectory_1/javascript_file_2.js	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,2 @@
+line 1
+

Added: trunk/tests/storage/directory_1/subdirectory_1/suffixless_file_1
===================================================================
--- trunk/tests/storage/directory_1/subdirectory_1/suffixless_file_1	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/directory_1/subdirectory_1/suffixless_file_1	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,2 @@
+line 1
+

Added: trunk/tests/storage/directory_1/subdirectory_1/text_file_1.txt
===================================================================
--- trunk/tests/storage/directory_1/subdirectory_1/text_file_1.txt	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/directory_1/subdirectory_1/text_file_1.txt	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,2 @@
+line 1
+

Added: trunk/tests/storage/directory_1/subdirectory_1/text_file_2.txt
===================================================================
--- trunk/tests/storage/directory_1/subdirectory_1/text_file_2.txt	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/directory_1/subdirectory_1/text_file_2.txt	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,2 @@
+line 1
+

Added: trunk/tests/storage/directory_1/subdirectory_1/text_file_3.txt
===================================================================
--- trunk/tests/storage/directory_1/subdirectory_1/text_file_3.txt	2005-10-20 18:52:21 UTC (rev 366)
+++ trunk/tests/storage/directory_1/subdirectory_1/text_file_3.txt	2005-10-25 03:17:18 UTC (rev 367)
@@ -0,0 +1,2 @@
+line 1
+


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000348.html">[openrecord-svn] r366 - trunk/documentation
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#349">[ date ]</a>
              <a href="thread.html#349">[ thread ]</a>
              <a href="subject.html#349">[ subject ]</a>
              <a href="author.html#349">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/openrecord-svn">More information about the openrecord-svn
mailing list</a><br>
</body></html>
